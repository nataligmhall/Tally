
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mindful Path | Tracking with Care</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .active-tab { color: #6366f1; }
        .inactive-tab { color: #94a3b8; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .btn-bounce:active { transform: scale(0.95); }
    </style>
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai",
        "date-fns": "https://esm.sh/date-fns"
      }
    }
    </script>
</head>
<body class="bg-slate-50 text-slate-900 overflow-x-hidden">
    <!-- App Root Container -->
    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col pb-24 relative bg-white shadow-2xl shadow-slate-200">
        <!-- Rendered via JS -->
    </div>

    <!-- Navigation -->
    <nav class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-white/80 backdrop-blur-md border-t border-slate-100 flex justify-around p-4 safe-bottom z-50">
        <button onclick="window.switchTab('track')" id="btn-track" class="flex flex-col items-center gap-1 px-4 py-2 rounded-2xl transition-all active-tab">
            <i data-lucide="layout-grid" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold uppercase tracking-wider">Track</span>
        </button>
        <button onclick="window.switchTab('trends')" id="btn-trends" class="flex flex-col items-center gap-1 px-4 py-2 rounded-2xl transition-all inactive-tab">
            <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold uppercase tracking-wider">Trends</span>
        </button>
        <button onclick="window.switchTab('settings')" id="btn-settings" class="flex flex-col items-center gap-1 px-4 py-2 rounded-2xl transition-all inactive-tab">
            <i data-lucide="settings" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold uppercase tracking-wider">Config</span>
        </button>
    </nav>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";
        import { format, subDays, isSameDay } from "date-fns";

        // --- Core Application State ---
        const DEFAULT_SETTINGS = {
            userName: "Traveler",
            dailyGoal: "Mindful Clarity",
            positiveSymbol: "ðŸŒ±",
            negativeSymbol: "ðŸ’¨"
        };

        let records = JSON.parse(localStorage.getItem('mindful_records') || '[]');
        let settings = JSON.parse(localStorage.getItem('mindful_settings') || JSON.stringify(DEFAULT_SETTINGS));
        let currentTab = 'track';
        let insightMessage = "Reflecting on your journey...";
        let isInsightLoading = false;

        const persist = () => {
            localStorage.setItem('mindful_records', JSON.stringify(records));
            localStorage.setItem('mindful_settings', JSON.stringify(settings));
        };

        // --- Gemini AI Interaction ---
        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

        async function refreshInsight() {
            if (records.length === 0) {
                insightMessage = "Welcome to your Mindful Path. Start your journey by recording your first day.";
                renderUI();
                return;
            }
            
            isInsightLoading = true;
            renderUI();

            const recentHistory = records.slice(-14).map(r => ({ type: r.type, date: r.date }));
            const prompt = `
                User Name: ${settings.userName}
                Recent History: ${JSON.stringify(recentHistory)}
                Intention: ${settings.dailyGoal}
                
                The user is tracking cannabis use for self-improvement. 
                "positive" means they reached their goal for that day. 
                "negative" means they used cannabis when they perhaps didn't want to.
                
                Provide ONE short, warm, supportive sentence (max 20 words). 
                Focus on resilience, mindfulness patterns, or self-compassion. 
                NEVER use shaming language. Do not use words like "failure" or "relapse".
            `;

            try {
                const response = await ai.models.generateContent({
                    model: 'gemini-3-flash-preview',
                    contents: prompt,
                    config: {
                        temperature: 0.7,
                        topP: 0.8,
                    },
                });
                
                insightMessage = response.text || "You are making progress just by being here and staying aware.";
            } catch (err) {
                console.error("Gemini AI error:", err);
                insightMessage = "Keep moving forward at your own pace. Every small moment of awareness counts.";
            } finally {
                isInsightLoading = false;
                renderUI();
            }
        }

        // --- UI Rendering Engine ---
        const root = document.getElementById('app');

        function renderUI() {
            root.innerHTML = '';
            
            const header = document.createElement('header');
            header.className = "p-6 pt-10 flex justify-between items-center bg-white/50 backdrop-blur-sm sticky top-0 z-40";
            header.innerHTML = `
                <div>
                    <h1 class="text-2xl font-black text-slate-900 tracking-tight">Mindful Path</h1>
                    <div class="flex items-center gap-1.5 mt-1 text-slate-500">
                        <i data-lucide="heart" class="w-3 h-3 text-red-400 fill-red-400"></i>
                        <span class="text-[10px] font-bold uppercase tracking-widest opacity-70">${settings.dailyGoal}</span>
                    </div>
                </div>
                <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white font-black shadow-lg shadow-indigo-100 ring-4 ring-white">
                    ${settings.userName.charAt(0).toUpperCase()}
                </div>
            `;
            root.appendChild(header);

            const content = document.createElement('main');
            content.className = "flex-1 px-6 overflow-y-auto pb-12";
            
            if (currentTab === 'track') renderTrack(content);
            else if (currentTab === 'trends') renderTrends(content);
            else if (currentTab === 'settings') renderSettings(content);
            
            root.appendChild(content);
            
            lucide.createIcons();
            refreshNavState();
        }

        function renderTrack(container) {
            const aiBox = document.createElement('div');
            aiBox.className = "bg-indigo-50 border border-indigo-100 rounded-[2rem] p-5 mb-8 shadow-sm relative overflow-hidden";
            aiBox.innerHTML = `
                <div class="flex items-center gap-2 mb-2 relative z-10">
                    <i data-lucide="sparkles" class="w-4 h-4 text-indigo-500"></i>
                    <span class="text-[10px] font-bold text-indigo-600 uppercase tracking-widest">Mindful Insight</span>
                </div>
                <p class="text-slate-700 italic text-sm leading-relaxed relative z-10">
                    ${isInsightLoading ? '<span class="animate-pulse opacity-50">Tuning in to your path...</span>' : insightMessage}
                </p>
                <div class="absolute -right-4 -bottom-4 opacity-5">
                    <i data-lucide="sparkles" class="w-24 h-24 text-indigo-900"></i>
                </div>
            `;
            container.appendChild(aiBox);

            const todayKey = format(new Date(), 'yyyy-MM-dd');
            const todayLog = records.find(r => r.date === todayKey);
            
            const logCard = document.createElement('div');
            logCard.className = "bg-white rounded-[2rem] p-6 shadow-xl shadow-slate-100 mb-8 border border-slate-50";
            logCard.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-xl font-extrabold text-slate-800">How's your day?</h2>
                    <p class="text-xs font-semibold text-slate-400 mt-0.5 uppercase tracking-tighter">${format(new Date(), 'EEEE, MMMM do')}</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="window.logDay('positive')" class="btn-bounce group flex flex-col items-center justify-center py-8 rounded-3xl transition-all active:scale-95 ${todayLog?.type === 'positive' ? 'bg-red-50 ring-2 ring-red-500 text-red-700' : 'bg-red-500 text-white shadow-lg shadow-red-200 hover:bg-red-600'}">
                        <div class="text-4xl mb-2 group-hover:scale-110 transition-transform">${settings.positiveSymbol}</div>
                        <span class="font-bold text-sm">Goal Met</span>
                        ${todayLog?.type === 'positive' ? '<i data-lucide="check-circle-2" class="w-4 h-4 mt-2"></i>' : ''}
                    </button>
                    <button onclick="window.logDay('negative')" class="btn-bounce group flex flex-col items-center justify-center py-8 rounded-3xl transition-all active:scale-95 ${todayLog?.type === 'negative' ? 'bg-slate-100 ring-2 ring-slate-800 text-slate-800' : 'bg-slate-800 text-white shadow-lg shadow-slate-200 hover:bg-slate-900'}">
                        <div class="text-4xl mb-2 group-hover:scale-110 transition-transform">${settings.negativeSymbol}</div>
                        <span class="font-bold text-sm">I Used</span>
                        ${todayLog?.type === 'negative' ? '<i data-lucide="check-circle-2" class="w-4 h-4 mt-2"></i>' : ''}
                    </button>
                </div>
            `;
            container.appendChild(logCard);

            const gridSection = document.createElement('div');
            gridSection.innerHTML = `
                <h3 class="text-sm font-black text-slate-900 mb-4 flex justify-between items-center px-1">
                    ACTIVITY LOG
                    <span class="text-[10px] font-bold text-slate-300">PAST 30 DAYS</span>
                </h3>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
            `;
            container.appendChild(gridSection);
            
            const calendar = gridSection.querySelector('#calendar-grid');
            const end = new Date();
            for (let i = 29; i >= 0; i--) {
                const date = subDays(end, i);
                const key = format(date, 'yyyy-MM-dd');
                const log = records.find(r => r.date === key);
                const isNow = isSameDay(date, end);
                
                let color = 'bg-slate-100';
                if (log?.type === 'positive') color = 'bg-red-500';
                else if (log?.type === 'negative') color = 'bg-slate-800';
                
                const cell = document.createElement('div');
                cell.className = "flex flex-col items-center";
                cell.innerHTML = `
                    <div class="w-10 h-10 rounded-xl ${color} ${isNow ? 'ring-2 ring-indigo-400 ring-offset-2 scale-110' : ''} flex items-center justify-center shadow-sm" title="${format(date, 'MMM d')}">
                        ${log?.type === 'positive' ? '<span class="text-white text-xs font-bold">âœ“</span>' : (log?.type === 'negative' ? '<span class="text-white text-xs font-bold">âœ•</span>' : '')}
                    </div>
                    <span class="text-[9px] mt-2 font-bold text-slate-400">${format(date, 'EE').charAt(0)}</span>
                `;
                calendar.appendChild(cell);
            }
        }

        function renderTrends(container) {
            const chartWrap = document.createElement('div');
            chartWrap.className = "bg-white rounded-[2rem] p-6 shadow-xl shadow-slate-50 border border-slate-50 mb-8";
            chartWrap.innerHTML = `
                <h3 class="text-lg font-black text-slate-800 mb-1">Success Flow</h3>
                <p class="text-[10px] font-bold text-slate-400 mb-8 uppercase tracking-widest">7-Day Consistency Average</p>
                <div class="h-56 w-full"><canvas id="consistencyChart"></canvas></div>
            `;
            container.appendChild(chartWrap);

            setTimeout(() => {
                const ctx = document.getElementById('consistencyChart').getContext('2d');
                const labels = [];
                const values = [];
                
                for (let i = 13; i >= 0; i--) {
                    const date = subDays(new Date(), i);
                    labels.push(format(date, 'MMM d'));
                    
                    const windowStart = subDays(date, 6);
                    const windowItems = records.filter(r => {
                        const d = new Date(r.date);
                        return d >= windowStart && d <= date;
                    });
                    
                    const metCount = windowItems.filter(r => r.type === 'positive').length;
                    const pct = windowItems.length > 0 ? (metCount / windowItems.length) * 100 : 0;
                    values.push(Math.round(pct));
                }

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            data: values,
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.08)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 5,
                            pointRadius: 3,
                            pointBackgroundColor: '#6366f1',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, max: 100, grid: { color: '#f1f5f9' }, ticks: { font: { weight: 'bold', size: 9 }, color: '#94a3b8' } },
                            x: { grid: { display: false }, ticks: { font: { weight: 'bold', size: 9 }, color: '#94a3b8' } }
                        }
                    }
                });
            }, 100);

            const statGrid = document.createElement('div');
            statGrid.className = "grid grid-cols-2 gap-4";
            statGrid.innerHTML = `
                <div class="bg-red-50 p-6 rounded-[2rem] border border-red-100">
                    <span class="text-[9px] font-black text-red-400 uppercase tracking-widest block mb-2">Goals Met</span>
                    <span class="text-4xl font-black text-red-600">${records.filter(r => r.type === 'positive').length}</span>
                </div>
                <div class="bg-slate-100 p-6 rounded-[2rem] border border-slate-200">
                    <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-2">Total Logs</span>
                    <span class="text-4xl font-black text-slate-800">${records.length}</span>
                </div>
            `;
            container.appendChild(statGrid);
        }

        function renderSettings(container) {
            const settingsView = document.createElement('div');
            settingsView.className = "space-y-6";
            settingsView.innerHTML = `
                <div class="bg-white rounded-[2rem] p-7 shadow-sm border border-slate-100">
                    <div class="flex items-center gap-3 mb-8">
                        <i data-lucide="user-circle" class="w-6 h-6 text-indigo-500"></i>
                        <h3 class="text-xl font-black text-slate-800">Your Identity</h3>
                    </div>
                    <div class="space-y-6">
                        <div>
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 px-1">Display Name</label>
                            <input type="text" oninput="window.changeSetting('userName', this.value)" value="${settings.userName}" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 px-1">Daily Intention</label>
                            <input type="text" oninput="window.changeSetting('dailyGoal', this.value)" value="${settings.dailyGoal}" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-[2rem] p-7 shadow-sm border border-slate-100">
                    <div class="flex items-center gap-3 mb-8">
                        <i data-lucide="palette" class="w-6 h-6 text-indigo-500"></i>
                        <h3 class="text-xl font-black text-slate-800">Customization</h3>
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 px-1">Goal Met Icon</label>
                            <input type="text" oninput="window.changeSetting('positiveSymbol', this.value)" value="${settings.positiveSymbol}" class="w-full p-4 text-3xl text-center bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 px-1">Usage Icon</label>
                            <input type="text" oninput="window.changeSetting('negativeSymbol', this.value)" value="${settings.negativeSymbol}" class="w-full p-4 text-3xl text-center bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                </div>

                <div class="p-8 bg-gradient-to-br from-slate-900 to-slate-800 rounded-[2.5rem] text-white shadow-2xl relative overflow-hidden">
                    <h4 class="text-lg font-black mb-2 relative z-10">Data Sovereignty</h4>
                    <p class="text-xs font-medium opacity-60 leading-relaxed relative z-10">
                        Mindful Path is a local-first application. Your logs never leave this device. 
                        Your privacy is hard-coded into the architecture.
                    </p>
                    <i data-lucide="shield-check" class="absolute -right-4 -bottom-4 w-32 h-32 opacity-10"></i>
                </div>
            `;
            container.appendChild(settingsView);
        }

        function refreshNavState() {
            ['track', 'trends', 'settings'].forEach(t => {
                const el = document.getElementById(`btn-${t}`);
                if (t === currentTab) {
                    el.classList.add('active-tab');
                    el.classList.remove('inactive-tab');
                    el.classList.add('scale-110');
                } else {
                    el.classList.add('inactive-tab');
                    el.classList.remove('active-tab');
                    el.classList.remove('scale-110');
                }
            });
        }

        window.switchTab = (tab) => {
            currentTab = tab;
            renderUI();
            if (tab === 'track') refreshInsight();
        };

        window.logDay = (type) => {
            const today = format(new Date(), 'yyyy-MM-dd');
            const idx = records.findIndex(r => r.date === today);
            const entry = {
                id: idx >= 0 ? records[idx].id : Date.now().toString(),
                date: today,
                type,
                loggedAt: new Date().toISOString()
            };

            if (idx >= 0) records[idx] = entry;
            else records.push(entry);
            
            persist();
            refreshInsight();
            renderUI();
        };

        window.changeSetting = (key, val) => {
            settings[key] = val;
            persist();
            renderUI();
        };

        renderUI();
        refreshInsight();
    </script>
</body>
</html>
